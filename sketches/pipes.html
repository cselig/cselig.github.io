<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>cselig</title><link rel="icon" href="favicon.ico"/><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/62ae7adc418c4fa89ac0.css" as="style"/><link rel="stylesheet" href="/_next/static/css/62ae7adc418c4fa89ac0.css" data-n-g=""/><link rel="preload" href="/_next/static/css/b3c25108c77d22e4bb58.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b3c25108c77d22e4bb58.css" data-n-p=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-70acde2203962b3dc5d4.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-50d38cb9c3dd5374e2a2.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.0a4392dc64510ab178c1.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.6d3bde474c27debf47e2.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-1018bc17b6123053b3bf.js" as="script"/><link rel="preload" href="/_next/static/chunks/fe66c3e56503ac18952228a608ca3464c3766972.02ceb7646fd5a00b4908.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/sketches/%5Bid%5D-efff1a0c2435fd0b2b31.js" as="script"/></head><body><div id="__next"><div class="layout_container__3H2Qg"><svg class="MuiSvgIcon-root layout_back_button__-f7Kp" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg><h1 class="sketch_title__2-Xm5">The Windows &quot;Pipes&quot; Screensaver</h1><div><p>I came across a GIF of the old "pipes" screensaver from Windows '95 and thought it would be fun to make.
It ended up being a fun challenge, and involved implementing some vector math. I haven't yet gotten around
to the hardest part though, which is making sure the pipes don't intersect themselves.</p>
</div><div></div><h2>Code:</h2><div><pre style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code class="language-javascript" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none"><span class="token module" style="color:#ef3b7d">import</span><span> </span><span class="token imports maybe-class-name">React</span><span> </span><span class="token module" style="color:#ef3b7d">from</span><span> </span><span class="token" style="color:#e6d06c">&#x27;react&#x27;</span><span>
</span><span></span><span class="token module" style="color:#ef3b7d">import</span><span> </span><span class="token" style="color:#a77afe">*</span><span> </span><span class="token module" style="color:#ef3b7d">as</span><span> </span><span class="token constant">THREE</span><span> </span><span class="token module" style="color:#ef3b7d">from</span><span> </span><span class="token" style="color:#e6d06c">&#x27;three&#x27;</span><span>
</span><span></span><span class="token module" style="color:#ef3b7d">import</span><span> </span><span class="token imports" style="color:#a77afe">*</span><span class="token imports"> </span><span class="token imports module" style="color:#ef3b7d">as</span><span class="token imports"> d3</span><span> </span><span class="token module" style="color:#ef3b7d">from</span><span> </span><span class="token" style="color:#e6d06c">&#x27;d3&#x27;</span><span>
</span>
<span></span><span class="token module" style="color:#ef3b7d">import</span><span> </span><span class="token imports">styles</span><span> </span><span class="token module" style="color:#ef3b7d">from</span><span> </span><span class="token" style="color:#e6d06c">&#x27;../../styles/sketches/pipes.module.scss&#x27;</span><span>
</span>
<span></span><span class="token" style="color:#ef3b7d">class</span><span> </span><span class="token class-name">Pipes</span><span> </span><span class="token" style="color:#ef3b7d">extends</span><span> </span><span class="token class-name">React</span><span class="token class-name" style="color:#bebec5">.</span><span class="token class-name">Component</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>  </span><span class="token function">render</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>    </span><span class="token control-flow" style="color:#ef3b7d">return</span><span> </span><span class="token" style="color:#bebec5">(</span><span>
</span><span>      </span><span class="token" style="color:#a77afe">&lt;</span><span>div id</span><span class="token" style="color:#a77afe">=</span><span class="token" style="color:#e6d06c">&quot;pipes-container&quot;</span><span> className</span><span class="token" style="color:#a77afe">=</span><span class="token" style="color:#bebec5">{</span><span>styles</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">container</span><span class="token" style="color:#bebec5">}</span><span class="token" style="color:#a77afe">&gt;</span><span>
</span><span>        </span><span class="token" style="color:#a77afe">&lt;</span><span>button name</span><span class="token" style="color:#a77afe">=</span><span class="token" style="color:#e6d06c">&quot;start&quot;</span><span class="token" style="color:#a77afe">&gt;</span><span class="token maybe-class-name">Start</span><span class="token" style="color:#a77afe">/</span><span class="token maybe-class-name">Reset</span><span class="token" style="color:#a77afe">&lt;</span><span class="token" style="color:#a77afe">/</span><span>button</span><span class="token" style="color:#a77afe">&gt;</span><span>
</span><span>        </span><span class="token" style="color:#a77afe">&lt;</span><span>div style</span><span class="token" style="color:#a77afe">=</span><span class="token" style="color:#bebec5">{</span><span class="token" style="color:#bebec5">{</span><span>display</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#e6d06c">&quot;flex&quot;</span><span class="token" style="color:#bebec5">,</span><span> alignItems</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#e6d06c">&quot;center&quot;</span><span class="token" style="color:#bebec5">}</span><span class="token" style="color:#bebec5">}</span><span class="token" style="color:#a77afe">&gt;</span><span>
</span><span>          </span><span class="token" style="color:#a77afe">&lt;</span><span>p</span><span class="token" style="color:#a77afe">&gt;</span><span class="token maybe-class-name">Rotate</span><span> </span><span class="token maybe-class-name">Camera</span><span class="token" style="color:#a77afe">:</span><span class="token" style="color:#a77afe">&lt;</span><span class="token" style="color:#a77afe">/</span><span>p</span><span class="token" style="color:#a77afe">&gt;</span><span>
</span><span>          </span><span class="token" style="color:#a77afe">&lt;</span><span>input type</span><span class="token" style="color:#a77afe">=</span><span class="token" style="color:#e6d06c">&quot;checkbox&quot;</span><span> name</span><span class="token" style="color:#a77afe">=</span><span class="token" style="color:#e6d06c">&quot;toggle-rotate&quot;</span><span class="token" style="color:#a77afe">/</span><span class="token" style="color:#a77afe">&gt;</span><span>
</span><span>        </span><span class="token" style="color:#a77afe">&lt;</span><span class="token" style="color:#a77afe">/</span><span>div</span><span class="token" style="color:#a77afe">&gt;</span><span>
</span><span>        </span><span class="token" style="color:#a77afe">&lt;</span><span>div className</span><span class="token" style="color:#a77afe">=</span><span class="token" style="color:#bebec5">{</span><span>styles</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">canvas</span><span> </span><span class="token" style="color:#a77afe">+</span><span> </span><span class="token" style="color:#e6d06c">&quot; canvas&quot;</span><span class="token" style="color:#bebec5">}</span><span class="token" style="color:#a77afe">&gt;</span><span class="token" style="color:#a77afe">&lt;</span><span class="token" style="color:#a77afe">/</span><span>div</span><span class="token" style="color:#a77afe">&gt;</span><span>
</span><span>      </span><span class="token" style="color:#a77afe">&lt;</span><span class="token" style="color:#a77afe">/</span><span>div</span><span class="token" style="color:#a77afe">&gt;</span><span>
</span><span>    </span><span class="token" style="color:#bebec5">)</span><span>
</span><span>  </span><span class="token" style="color:#bebec5">}</span><span>
</span>
<span>  </span><span class="token function">componentDidMount</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>    </span><span class="token" style="color:#ef3b7d">let</span><span> container </span><span class="token" style="color:#a77afe">=</span><span> d3</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">select</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#e6d06c">&quot;#pipes-container .canvas&quot;</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">node</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span>
</span><span>        bbox </span><span class="token" style="color:#a77afe">=</span><span> container</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">getBoundingClientRect</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span>
<span>    </span><span class="token" style="color:#ef3b7d">let</span><span> scene</span><span class="token" style="color:#bebec5">,</span><span> camera</span><span class="token" style="color:#bebec5">;</span><span>
</span>
<span>    </span><span class="token" style="color:#ef3b7d">let</span><span> renderer </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">new</span><span> </span><span class="token class-name">THREE</span><span class="token class-name" style="color:#bebec5">.</span><span class="token class-name">WebGLRenderer</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>    renderer</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">setPixelRatio</span><span class="token" style="color:#bebec5">(</span><span class="token dom" style="color:#fff">window</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">devicePixelRatio</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span>
<span>    renderer</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">setSize</span><span class="token" style="color:#bebec5">(</span><span>bbox</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">width</span><span class="token" style="color:#bebec5">,</span><span> bbox</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">height</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>    container</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">appendChild</span><span class="token" style="color:#bebec5">(</span><span>renderer</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">domElement</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span>
<span>    </span><span class="token" style="color:#ef3b7d">const</span><span> </span><span class="token constant">SPEED</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">3</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#6f705e">// units/frame</span><span>
</span><span>          </span><span class="token constant">R</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#6f705e">// cylinder radius</span><span>
</span><span>          </span><span class="token constant">L</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">80</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#6f705e">// size of cube boundary</span><span>
</span><span>          </span><span class="token constant">RADIAL_SEGMENTS</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">32</span><span class="token" style="color:#bebec5">,</span><span>
</span><span>          </span><span class="token constant">MAX_SEGMENTS</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">70</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#6f705e">// max segments per pipe</span><span>
</span><span>          </span><span class="token constant">MIN_LENGTH</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">5</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#6f705e">// min length of a pipe segment</span><span>
</span><span>          </span><span class="token constant">MAX_LENGTH</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">20</span><span class="token" style="color:#bebec5">,</span><span>
</span><span>          </span><span class="token constant">CUBE_CENTER</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#bebec5">[</span><span class="token constant">L</span><span class="token" style="color:#a77afe">/</span><span class="token" style="color:#a77afe">2</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token constant">L</span><span class="token" style="color:#a77afe">/</span><span class="token" style="color:#a77afe">2</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token constant">L</span><span class="token" style="color:#a77afe">/</span><span class="token" style="color:#a77afe">2</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">;</span><span>
</span>
<span>    </span><span class="token" style="color:#ef3b7d">const</span><span> initialPositions </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#bebec5">[</span><span>
</span><span>      </span><span class="token" style="color:#bebec5">[</span><span class="token constant">L</span><span class="token" style="color:#a77afe">/</span><span class="token" style="color:#a77afe">2</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token constant">L</span><span class="token" style="color:#a77afe">/</span><span class="token" style="color:#a77afe">2</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">,</span><span>
</span><span>      </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">3</span><span class="token" style="color:#a77afe">/</span><span class="token" style="color:#a77afe">4</span><span class="token" style="color:#a77afe">*</span><span class="token constant">L</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">3</span><span class="token" style="color:#a77afe">/</span><span class="token" style="color:#a77afe">4</span><span class="token" style="color:#a77afe">*</span><span class="token constant">L</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">,</span><span>
</span><span>      </span><span class="token" style="color:#bebec5">[</span><span class="token constant">L</span><span class="token" style="color:#a77afe">/</span><span class="token" style="color:#a77afe">2</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token constant">L</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token constant">L</span><span class="token" style="color:#a77afe">/</span><span class="token" style="color:#a77afe">2</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">,</span><span>
</span><span>    </span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>    </span><span class="token" style="color:#ef3b7d">const</span><span> colors </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#bebec5">[</span><span>
</span><span>      </span><span class="token" style="color:#a77afe">0x3182bd</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#6f705e">// blue</span><span>
</span><span>      </span><span class="token" style="color:#a77afe">0x229954</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#6f705e">// green</span><span>
</span><span>      </span><span class="token" style="color:#a77afe">0xF08080</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#6f705e">// coral</span><span>
</span><span>    </span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>    </span><span class="token" style="color:#ef3b7d">const</span><span> </span><span class="token constant">MAX_PIPES</span><span> </span><span class="token" style="color:#a77afe">=</span><span> colors</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">length</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>    </span><span class="token" style="color:#ef3b7d">let</span><span> materials </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>    </span><span class="token control-flow" style="color:#ef3b7d">for</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#ef3b7d">const</span><span> color </span><span class="token" style="color:#ef3b7d">of</span><span> colors</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>      materials</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">push</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#ef3b7d">new</span><span> </span><span class="token class-name">THREE</span><span class="token class-name" style="color:#bebec5">.</span><span class="token class-name">MeshStandardMaterial</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">{</span><span>color</span><span class="token" style="color:#a77afe">:</span><span> color</span><span class="token" style="color:#bebec5">}</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span>
<span>    </span><span class="token" style="color:#ef3b7d">const</span><span> bounds </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">new</span><span> </span><span class="token class-name">THREE</span><span class="token class-name" style="color:#bebec5">.</span><span class="token class-name">Box3</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#ef3b7d">new</span><span> </span><span class="token class-name">THREE</span><span class="token class-name" style="color:#bebec5">.</span><span class="token class-name">Vector3</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#ef3b7d">new</span><span> </span><span class="token class-name">THREE</span><span class="token class-name" style="color:#bebec5">.</span><span class="token class-name">Vector3</span><span class="token" style="color:#bebec5">(</span><span class="token constant">L</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token constant">L</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token constant">L</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span>
<span>    </span><span class="token" style="color:#6f705e">// utils</span><span>
</span><span>    </span><span class="token" style="color:#ef3b7d">const</span><span> </span><span class="token function-variable function">randInt</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">function</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">min</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter"> max</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>      </span><span class="token control-flow" style="color:#ef3b7d">return</span><span> </span><span class="token known-class-name class-name">Math</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">floor</span><span class="token" style="color:#bebec5">(</span><span class="token known-class-name class-name">Math</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">random</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#a77afe">*</span><span> </span><span class="token" style="color:#bebec5">(</span><span>max </span><span class="token" style="color:#a77afe">-</span><span> min</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#a77afe">+</span><span> min</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span>
<span>    </span><span class="token" style="color:#ef3b7d">const</span><span> </span><span class="token function-variable function">randChoice</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">function</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">arr</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>      </span><span class="token control-flow" style="color:#ef3b7d">return</span><span> arr</span><span class="token" style="color:#bebec5">[</span><span class="token known-class-name class-name">Math</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">floor</span><span class="token" style="color:#bebec5">(</span><span class="token known-class-name class-name">Math</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">random</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#a77afe">*</span><span>arr</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">length</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span>
<span>    </span><span class="token" style="color:#ef3b7d">const</span><span> </span><span class="token function-variable function">newDirection</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">function</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">old_dir</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter"> position</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>      </span><span class="token" style="color:#6f705e">// return a new direction vector such that:</span><span>
</span><span>      </span><span class="token" style="color:#6f705e">//   - new direction is orthogonal to old direction</span><span>
</span><span>      </span><span class="token" style="color:#6f705e">//   - a pipe going in new_direction with MAX_LENGTH will stay in bounds</span><span>
</span><span>      </span><span class="token" style="color:#ef3b7d">let</span><span> validDirs </span><span class="token" style="color:#a77afe">=</span><span> directions</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">filter</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">new_dir</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token arrow" style="color:#a77afe">=&gt;</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>        </span><span class="token control-flow" style="color:#ef3b7d">return</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token function">vector_dot</span><span class="token" style="color:#bebec5">(</span><span>old_dir</span><span class="token" style="color:#bebec5">,</span><span> new_dir</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#a77afe">===</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#a77afe">&amp;&amp;</span><span>
</span><span>              </span><span class="token function">willBeInBounds</span><span class="token" style="color:#bebec5">(</span><span>new_dir</span><span class="token" style="color:#bebec5">,</span><span> position</span><span class="token" style="color:#bebec5">)</span><span>
</span><span>      </span><span class="token" style="color:#bebec5">}</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      </span><span class="token control-flow" style="color:#ef3b7d">return</span><span> </span><span class="token function">randChoice</span><span class="token" style="color:#bebec5">(</span><span>validDirs</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span>
<span>    </span><span class="token" style="color:#ef3b7d">const</span><span> </span><span class="token function-variable function">willBeInBounds</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">function</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">dir</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter"> position</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>      </span><span class="token" style="color:#ef3b7d">const</span><span> end_position </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">vector_add</span><span class="token" style="color:#bebec5">(</span><span>position</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token function">vector_scale</span><span class="token" style="color:#bebec5">(</span><span>dir</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token constant">MAX_LENGTH</span><span> </span><span class="token" style="color:#a77afe">+</span><span> </span><span class="token" style="color:#a77afe">2</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      </span><span class="token control-flow" style="color:#ef3b7d">return</span><span> bounds</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">containsPoint</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#ef3b7d">new</span><span> </span><span class="token class-name">THREE</span><span class="token class-name" style="color:#bebec5">.</span><span class="token class-name">Vector3</span><span class="token" style="color:#bebec5">(</span><span class="token spread" style="color:#a77afe">...</span><span>end_position</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span>
<span>    </span><span class="token" style="color:#6f705e">// utility functions for working with vectors</span><span>
</span><span>    </span><span class="token" style="color:#6f705e">// could probably make this cleaner by not converting between</span><span>
</span><span>    </span><span class="token" style="color:#6f705e">// js lists and THREE.Vector3&#x27;s</span><span>
</span><span>    </span><span class="token" style="color:#ef3b7d">const</span><span> </span><span class="token function-variable function">pos_to_vec</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">function</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">pos</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>      </span><span class="token control-flow" style="color:#ef3b7d">return</span><span> </span><span class="token" style="color:#bebec5">[</span><span>pos</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">x</span><span class="token" style="color:#bebec5">,</span><span> pos</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">y</span><span class="token" style="color:#bebec5">,</span><span> pos</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">z</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span>
<span>    </span><span class="token" style="color:#ef3b7d">const</span><span> </span><span class="token function-variable function">vector_scale</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">function</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">v</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter"> s</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>      </span><span class="token" style="color:#ef3b7d">let</span><span> result </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      </span><span class="token control-flow" style="color:#ef3b7d">for</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#ef3b7d">let</span><span> i </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">;</span><span> i </span><span class="token" style="color:#a77afe">&lt;</span><span> v</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">length</span><span class="token" style="color:#bebec5">;</span><span> i</span><span class="token" style="color:#a77afe">++</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>        result</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">push</span><span class="token" style="color:#bebec5">(</span><span>v</span><span class="token" style="color:#bebec5">[</span><span>i</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#a77afe">*</span><span> s</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      </span><span class="token" style="color:#bebec5">}</span><span>
</span><span>      </span><span class="token control-flow" style="color:#ef3b7d">return</span><span> result</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span>
<span>    </span><span class="token" style="color:#ef3b7d">const</span><span> </span><span class="token function-variable function">vector_add</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">function</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">v1</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter"> v2</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>      </span><span class="token" style="color:#ef3b7d">let</span><span> result </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      </span><span class="token control-flow" style="color:#ef3b7d">for</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#ef3b7d">let</span><span> i </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">;</span><span> i </span><span class="token" style="color:#a77afe">&lt;</span><span> v1</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">length</span><span class="token" style="color:#bebec5">;</span><span> i</span><span class="token" style="color:#a77afe">++</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>        result</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">push</span><span class="token" style="color:#bebec5">(</span><span>v1</span><span class="token" style="color:#bebec5">[</span><span>i</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#a77afe">+</span><span> v2</span><span class="token" style="color:#bebec5">[</span><span>i</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      </span><span class="token" style="color:#bebec5">}</span><span>
</span><span>      </span><span class="token control-flow" style="color:#ef3b7d">return</span><span> result</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span>
<span>    </span><span class="token" style="color:#ef3b7d">const</span><span> </span><span class="token function-variable function">vector_dot</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">function</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">v1</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter"> v2</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>      </span><span class="token" style="color:#ef3b7d">let</span><span> result </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      </span><span class="token control-flow" style="color:#ef3b7d">for</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#ef3b7d">let</span><span> i </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">;</span><span> i </span><span class="token" style="color:#a77afe">&lt;</span><span> v1</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">length</span><span class="token" style="color:#bebec5">;</span><span> i</span><span class="token" style="color:#a77afe">++</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>        result </span><span class="token" style="color:#a77afe">+=</span><span> v1</span><span class="token" style="color:#bebec5">[</span><span>i</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#a77afe">*</span><span> v2</span><span class="token" style="color:#bebec5">[</span><span>i</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      </span><span class="token" style="color:#bebec5">}</span><span>
</span><span>      </span><span class="token control-flow" style="color:#ef3b7d">return</span><span> result</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span>
<span>    </span><span class="token" style="color:#ef3b7d">const</span><span> </span><span class="token function-variable function">createCylinder</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">function</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>      </span><span class="token" style="color:#ef3b7d">let</span><span> geometry </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">new</span><span> </span><span class="token class-name">THREE</span><span class="token class-name" style="color:#bebec5">.</span><span class="token class-name">CylinderGeometry</span><span class="token" style="color:#bebec5">(</span><span class="token constant">R</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token constant">R</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token constant">RADIAL_SEGMENTS</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      </span><span class="token" style="color:#ef3b7d">let</span><span> material </span><span class="token" style="color:#a77afe">=</span><span> materials</span><span class="token" style="color:#bebec5">[</span><span>numPipes</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      </span><span class="token" style="color:#ef3b7d">let</span><span> mesh </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">new</span><span> </span><span class="token class-name">THREE</span><span class="token class-name" style="color:#bebec5">.</span><span class="token class-name">Mesh</span><span class="token" style="color:#bebec5">(</span><span>geometry</span><span class="token" style="color:#bebec5">,</span><span> material</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      scene</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">add</span><span class="token" style="color:#bebec5">(</span><span>mesh</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      </span><span class="token control-flow" style="color:#ef3b7d">return</span><span> mesh</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span>
<span>    </span><span class="token" style="color:#ef3b7d">const</span><span> </span><span class="token function-variable function">createSphere</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">function</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>      </span><span class="token" style="color:#ef3b7d">let</span><span> geometry </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">new</span><span> </span><span class="token class-name">THREE</span><span class="token class-name" style="color:#bebec5">.</span><span class="token class-name">SphereGeometry</span><span class="token" style="color:#bebec5">(</span><span class="token constant">R</span><span> </span><span class="token" style="color:#a77afe">*</span><span> </span><span class="token" style="color:#a77afe">1.2</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token constant">RADIAL_SEGMENTS</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token constant">RADIAL_SEGMENTS</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      </span><span class="token" style="color:#ef3b7d">let</span><span> material </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">new</span><span> </span><span class="token class-name">THREE</span><span class="token class-name" style="color:#bebec5">.</span><span class="token class-name">MeshStandardMaterial</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">{</span><span>color</span><span class="token" style="color:#a77afe">:</span><span> colors</span><span class="token" style="color:#bebec5">[</span><span>numPipes</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">}</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      </span><span class="token" style="color:#ef3b7d">let</span><span> mesh </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">new</span><span> </span><span class="token class-name">THREE</span><span class="token class-name" style="color:#bebec5">.</span><span class="token class-name">Mesh</span><span class="token" style="color:#bebec5">(</span><span>geometry</span><span class="token" style="color:#bebec5">,</span><span> material</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      scene</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">add</span><span class="token" style="color:#bebec5">(</span><span>mesh</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      </span><span class="token control-flow" style="color:#ef3b7d">return</span><span> mesh</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span>
<span>    </span><span class="token" style="color:#ef3b7d">const</span><span> </span><span class="token function-variable function">rotateCylinder</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">function</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">c</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>      </span><span class="token control-flow" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token known-class-name class-name">Math</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">abs</span><span class="token" style="color:#bebec5">(</span><span>c</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">direction</span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#a77afe">===</span><span> </span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>        c</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">mesh</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">rotateZ</span><span class="token" style="color:#bebec5">(</span><span class="token known-class-name class-name">Math</span><span class="token" style="color:#bebec5">.</span><span class="token constant">PI</span><span> </span><span class="token" style="color:#a77afe">/</span><span> </span><span class="token" style="color:#a77afe">2</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      </span><span class="token" style="color:#bebec5">}</span><span> </span><span class="token control-flow" style="color:#ef3b7d">else</span><span> </span><span class="token control-flow" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token known-class-name class-name">Math</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">abs</span><span class="token" style="color:#bebec5">(</span><span>c</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">direction</span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">2</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#a77afe">===</span><span> </span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>        c</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">mesh</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">rotateX</span><span class="token" style="color:#bebec5">(</span><span class="token known-class-name class-name">Math</span><span class="token" style="color:#bebec5">.</span><span class="token constant">PI</span><span> </span><span class="token" style="color:#a77afe">/</span><span> </span><span class="token" style="color:#a77afe">2</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      </span><span class="token" style="color:#bebec5">}</span><span>
</span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span>
<span>    </span><span class="token" style="color:#ef3b7d">const</span><span> </span><span class="token function-variable function">computeCameraPos</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">function</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>      </span><span class="token" style="color:#ef3b7d">const</span><span> x </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token constant">L</span><span> </span><span class="token" style="color:#a77afe">*</span><span> </span><span class="token" style="color:#a77afe">1.5</span><span> </span><span class="token" style="color:#a77afe">*</span><span> </span><span class="token known-class-name class-name">Math</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">sin</span><span class="token" style="color:#bebec5">(</span><span>theta</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      </span><span class="token" style="color:#ef3b7d">const</span><span> y </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token constant">L</span><span> </span><span class="token" style="color:#a77afe">*</span><span> </span><span class="token" style="color:#a77afe">1.5</span><span> </span><span class="token" style="color:#a77afe">*</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token known-class-name class-name">Math</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">cos</span><span class="token" style="color:#bebec5">(</span><span>theta</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#a77afe">+</span><span> </span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      </span><span class="token control-flow" style="color:#ef3b7d">return</span><span> </span><span class="token" style="color:#bebec5">[</span><span>x</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token constant">L</span><span class="token" style="color:#a77afe">/</span><span class="token" style="color:#a77afe">2</span><span class="token" style="color:#bebec5">,</span><span> y</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span>
<span>    </span><span class="token" style="color:#ef3b7d">const</span><span> </span><span class="token function-variable function">updateCamera</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">function</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>      camera</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">position</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">set</span><span class="token" style="color:#bebec5">(</span><span class="token spread" style="color:#a77afe">...</span><span class="token method function property-access">computeCameraPos</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span>
</span><span>      camera</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">lookAt</span><span class="token" style="color:#bebec5">(</span><span class="token spread" style="color:#a77afe">...</span><span class="token constant">CUBE_CENTER</span><span class="token" style="color:#bebec5">)</span><span>
</span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span>
<span>    </span><span class="token" style="color:#ef3b7d">const</span><span> directions </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#bebec5">[</span><span>
</span><span>      </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">,</span><span>
</span><span>      </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">,</span><span>
</span><span>      </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">,</span><span>
</span><span>      </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">-</span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">,</span><span>
</span><span>      </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">-</span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">,</span><span>
</span><span>      </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">-</span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">,</span><span>
</span><span>    </span><span class="token" style="color:#bebec5">]</span><span>
</span>
<span>    </span><span class="token" style="color:#ef3b7d">let</span><span> numSegments</span><span class="token" style="color:#bebec5">;</span><span> </span><span class="token" style="color:#6f705e">// number of pipe segments that have been created</span><span>
</span><span>    </span><span class="token" style="color:#ef3b7d">let</span><span> numPipes</span><span class="token" style="color:#bebec5">;</span><span> </span><span class="token" style="color:#6f705e">// number of pipes that have been created</span><span>
</span><span>    </span><span class="token" style="color:#ef3b7d">let</span><span> c</span><span class="token" style="color:#bebec5">;</span><span> </span><span class="token" style="color:#6f705e">// keeps track of the current cylinder segment</span><span>
</span><span>    </span><span class="token" style="color:#ef3b7d">let</span><span> theta </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">8</span><span class="token" style="color:#bebec5">;</span><span> </span><span class="token" style="color:#6f705e">// current camera rotation</span><span>
</span><span>    </span><span class="token" style="color:#ef3b7d">let</span><span> omega </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">0.01</span><span class="token" style="color:#bebec5">;</span><span> </span><span class="token" style="color:#6f705e">// rotational speed</span><span>
</span><span>    </span><span class="token" style="color:#ef3b7d">let</span><span> rotateCamera </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">false</span><span class="token" style="color:#bebec5">;</span><span>
</span>
<span>    </span><span class="token" style="color:#ef3b7d">let</span><span> animationRequestId</span><span class="token" style="color:#bebec5">;</span><span>
</span>
<span>    </span><span class="token" style="color:#ef3b7d">const</span><span> </span><span class="token function-variable function">animate</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">function</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>      animationRequestId </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">requestAnimationFrame</span><span class="token" style="color:#bebec5">(</span><span>animate</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span>
<span>      </span><span class="token control-flow" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>c</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">length</span><span> </span><span class="token" style="color:#a77afe">&lt;</span><span> c</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">max_length</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>        c</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">length</span><span> </span><span class="token" style="color:#a77afe">+=</span><span> </span><span class="token constant">SPEED</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>        c</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">mesh</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">geometry</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">dispose</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>        c</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">mesh</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">geometry</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">new</span><span> </span><span class="token class-name">THREE</span><span class="token class-name" style="color:#bebec5">.</span><span class="token class-name">CylinderGeometry</span><span class="token" style="color:#bebec5">(</span><span class="token constant">R</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token constant">R</span><span class="token" style="color:#bebec5">,</span><span> c</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">length</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token constant">RADIAL_SEGMENTS</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>        </span><span class="token" style="color:#6f705e">// need to make sure cylinder only grows in one direction</span><span>
</span><span>        </span><span class="token" style="color:#ef3b7d">const</span><span> old_pos </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">pos_to_vec</span><span class="token" style="color:#bebec5">(</span><span>c</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">mesh</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">position</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>        </span><span class="token" style="color:#ef3b7d">const</span><span> new_pos </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">vector_add</span><span class="token" style="color:#bebec5">(</span><span>old_pos</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token function">vector_scale</span><span class="token" style="color:#bebec5">(</span><span>c</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">direction</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token constant">SPEED</span><span class="token" style="color:#a77afe">/</span><span class="token" style="color:#a77afe">2</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>        c</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">mesh</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">position</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">set</span><span class="token" style="color:#bebec5">(</span><span class="token spread" style="color:#a77afe">...</span><span>new_pos</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      </span><span class="token" style="color:#bebec5">}</span><span> </span><span class="token control-flow" style="color:#ef3b7d">else</span><span> </span><span class="token control-flow" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>numSegments</span><span class="token" style="color:#a77afe">++</span><span> </span><span class="token" style="color:#a77afe">&lt;</span><span> </span><span class="token constant">MAX_SEGMENTS</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>        </span><span class="token" style="color:#6f705e">// new pipe segment</span><span>
</span><span>        </span><span class="token" style="color:#ef3b7d">const</span><span> end_position </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">vector_add</span><span class="token" style="color:#bebec5">(</span><span class="token function">pos_to_vec</span><span class="token" style="color:#bebec5">(</span><span>c</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">mesh</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">position</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token function">vector_scale</span><span class="token" style="color:#bebec5">(</span><span>c</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">direction</span><span class="token" style="color:#bebec5">,</span><span> c</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">length</span><span class="token" style="color:#a77afe">/</span><span class="token" style="color:#a77afe">2</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>        </span><span class="token" style="color:#ef3b7d">const</span><span> old_pos </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">pos_to_vec</span><span class="token" style="color:#bebec5">(</span><span>c</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">mesh</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">position</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>        </span><span class="token" style="color:#ef3b7d">const</span><span> new_pos </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">vector_add</span><span class="token" style="color:#bebec5">(</span><span>old_pos</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token function">vector_scale</span><span class="token" style="color:#bebec5">(</span><span>c</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">direction</span><span class="token" style="color:#bebec5">,</span><span> c</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">length</span><span class="token" style="color:#a77afe">/</span><span class="token" style="color:#a77afe">2</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>        c </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>          length</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span>
</span><span>          direction</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token function">newDirection</span><span class="token" style="color:#bebec5">(</span><span>c</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">direction</span><span class="token" style="color:#bebec5">,</span><span> end_position</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span>
</span><span>          max_length</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token function">randInt</span><span class="token" style="color:#bebec5">(</span><span class="token constant">MIN_LENGTH</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token constant">MAX_LENGTH</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span>
</span><span>          mesh</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token function">createCylinder</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span>
</span><span>        </span><span class="token" style="color:#bebec5">}</span><span>
</span><span>        c</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">mesh</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">position</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">set</span><span class="token" style="color:#bebec5">(</span><span class="token spread" style="color:#a77afe">...</span><span>new_pos</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>        </span><span class="token function">rotateCylinder</span><span class="token" style="color:#bebec5">(</span><span>c</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>        </span><span class="token" style="color:#6f705e">// create sphere at junction</span><span>
</span><span>        </span><span class="token" style="color:#ef3b7d">let</span><span> sphere </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">createSphere</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>        sphere</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">position</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">set</span><span class="token" style="color:#bebec5">(</span><span class="token spread" style="color:#a77afe">...</span><span>new_pos</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      </span><span class="token" style="color:#bebec5">}</span><span> </span><span class="token control-flow" style="color:#ef3b7d">else</span><span> </span><span class="token control-flow" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>numPipes </span><span class="token" style="color:#a77afe">&lt;</span><span> </span><span class="token constant">MAX_PIPES</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>        </span><span class="token" style="color:#6f705e">// finish the old pipe with a sphere</span><span>
</span><span>        </span><span class="token" style="color:#ef3b7d">const</span><span> position </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">vector_add</span><span class="token" style="color:#bebec5">(</span><span class="token function">pos_to_vec</span><span class="token" style="color:#bebec5">(</span><span>c</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">mesh</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">position</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token function">vector_scale</span><span class="token" style="color:#bebec5">(</span><span>c</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">direction</span><span class="token" style="color:#bebec5">,</span><span> c</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">length</span><span class="token" style="color:#a77afe">/</span><span class="token" style="color:#a77afe">2</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>        </span><span class="token" style="color:#ef3b7d">let</span><span> sphere </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">createSphere</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>        sphere</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">position</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">set</span><span class="token" style="color:#bebec5">(</span><span class="token spread" style="color:#a77afe">...</span><span>position</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span>
<span>        </span><span class="token control-flow" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>numPipes </span><span class="token" style="color:#a77afe">&lt;</span><span> </span><span class="token constant">MAX_PIPES</span><span> </span><span class="token" style="color:#a77afe">-</span><span> </span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>          numPipes</span><span class="token" style="color:#a77afe">++</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>          numSegments </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>          </span><span class="token function">newPipe</span><span class="token" style="color:#bebec5">(</span><span>initialPositions</span><span class="token" style="color:#bebec5">[</span><span>numPipes</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>        </span><span class="token" style="color:#bebec5">}</span><span> </span><span class="token control-flow" style="color:#ef3b7d">else</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>          </span><span class="token function">init</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>        </span><span class="token" style="color:#bebec5">}</span><span>
</span><span>      </span><span class="token" style="color:#bebec5">}</span><span>
</span>
<span>      </span><span class="token control-flow" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>rotateCamera</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>        theta </span><span class="token" style="color:#a77afe">+=</span><span> omega</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>        </span><span class="token function">updateCamera</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      </span><span class="token" style="color:#bebec5">}</span><span>
</span>
<span>      renderer</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">render</span><span class="token" style="color:#bebec5">(</span><span>scene</span><span class="token" style="color:#bebec5">,</span><span> camera</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span>
<span>    </span><span class="token" style="color:#ef3b7d">const</span><span> </span><span class="token function-variable function">newPipe</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">function</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">position</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>      c </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>        length</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span>
</span><span>        direction</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token function">newDirection</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">,</span><span> position</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span>
</span><span>        max_length</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token function">randInt</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">3</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">5</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span>
</span><span>        mesh</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token function">createCylinder</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span>
</span><span>      </span><span class="token" style="color:#bebec5">}</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      </span><span class="token function">rotateCylinder</span><span class="token" style="color:#bebec5">(</span><span>c</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      c</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">mesh</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">position</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">set</span><span class="token" style="color:#bebec5">(</span><span class="token spread" style="color:#a77afe">...</span><span>position</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span>
<span>      </span><span class="token" style="color:#ef3b7d">let</span><span> s </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">createSphere</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      s</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">position</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">set</span><span class="token" style="color:#bebec5">(</span><span class="token spread" style="color:#a77afe">...</span><span>position</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span>
<span>    </span><span class="token" style="color:#ef3b7d">const</span><span> </span><span class="token function-variable function">setScene</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">function</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>      scene </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">new</span><span> </span><span class="token class-name">THREE</span><span class="token class-name" style="color:#bebec5">.</span><span class="token class-name">Scene</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      camera </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">new</span><span> </span><span class="token class-name">THREE</span><span class="token class-name" style="color:#bebec5">.</span><span class="token class-name">PerspectiveCamera</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">75</span><span class="token" style="color:#bebec5">,</span><span> bbox</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">width</span><span class="token" style="color:#a77afe">/</span><span>bbox</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">height</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0.1</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">1000</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span>
<span>      </span><span class="token function">updateCamera</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span>
<span>      </span><span class="token" style="color:#ef3b7d">let</span><span> light </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">new</span><span> </span><span class="token class-name">THREE</span><span class="token class-name" style="color:#bebec5">.</span><span class="token class-name">AmbientLight</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">0x404040</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">3</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      scene</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">add</span><span class="token" style="color:#bebec5">(</span><span>light</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span>
<span>      </span><span class="token" style="color:#ef3b7d">let</span><span> pointLight </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">new</span><span> </span><span class="token class-name">THREE</span><span class="token class-name" style="color:#bebec5">.</span><span class="token class-name">PointLight</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">0x404040</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">3</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      pointLight</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">position</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">set</span><span class="token" style="color:#bebec5">(</span><span class="token constant">L</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token constant">L</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token constant">L</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      scene</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">add</span><span class="token" style="color:#bebec5">(</span><span>pointLight</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span>
<span>      renderer</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">render</span><span class="token" style="color:#bebec5">(</span><span>scene</span><span class="token" style="color:#bebec5">,</span><span> camera</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span>
<span>    </span><span class="token" style="color:#ef3b7d">const</span><span> </span><span class="token function-variable function">init</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">function</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span><span>      </span><span class="token function">setScene</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span>
<span>      numSegments </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>      numPipes </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">;</span><span>
</span>
<span>      </span><span class="token function">newPipe</span><span class="token" style="color:#bebec5">(</span><span>initialPositions</span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span>
<span>      </span><span class="token function">cancelAnimationFrame</span><span class="token" style="color:#bebec5">(</span><span>animationRequestId</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span>
<span>      </span><span class="token function">animate</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span>
<span>    </span><span class="token function">setScene</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span>
<span>    d3</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">select</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#e6d06c">&quot;#pipes-container button[name=start]&quot;</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">on</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#e6d06c">&quot;click&quot;</span><span class="token" style="color:#bebec5">,</span><span> init</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span><span>    d3</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">select</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#e6d06c">&quot;#pipes-container input[name=toggle-rotate&quot;</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">on</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#e6d06c">&quot;change&quot;</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token arrow" style="color:#a77afe">=&gt;</span><span> rotateCamera </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">!</span><span>rotateCamera</span><span class="token" style="color:#bebec5">)</span><span>
</span><span>  </span><span class="token" style="color:#bebec5">}</span><span>
</span><span></span><span class="token" style="color:#bebec5">}</span><span>
</span>
<span></span><span class="token" style="color:#6f705e">// Downstream code is set up to display only functional components.</span><span>
</span><span></span><span class="token module" style="color:#ef3b7d">export</span><span> </span><span class="token module" style="color:#ef3b7d">default</span><span> </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function maybe-class-name">PipesFn</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span> </span><span class="token control-flow" style="color:#ef3b7d">return</span><span> </span><span class="token" style="color:#a77afe">&lt;</span><span class="token maybe-class-name">Pipes</span><span> </span><span class="token" style="color:#a77afe">/</span><span class="token" style="color:#a77afe">&gt;</span><span> </span><span class="token" style="color:#bebec5">}</span><span>
</span>
</code></pre></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"sketchData":{"id":"pipes","contentHtml":"\u003cp\u003eI came across a GIF of the old \"pipes\" screensaver from Windows '95 and thought it would be fun to make.\nIt ended up being a fun challenge, and involved implementing some vector math. I haven't yet gotten around\nto the hardest part though, which is making sure the pipes don't intersect themselves.\u003c/p\u003e\n","code":"import React from 'react'\nimport * as THREE from 'three'\nimport * as d3 from 'd3'\n\nimport styles from '../../styles/sketches/pipes.module.scss'\n\nclass Pipes extends React.Component {\n  render() {\n    return (\n      \u003cdiv id=\"pipes-container\" className={styles.container}\u003e\n        \u003cbutton name=\"start\"\u003eStart/Reset\u003c/button\u003e\n        \u003cdiv style={{display: \"flex\", alignItems: \"center\"}}\u003e\n          \u003cp\u003eRotate Camera:\u003c/p\u003e\n          \u003cinput type=\"checkbox\" name=\"toggle-rotate\"/\u003e\n        \u003c/div\u003e\n        \u003cdiv className={styles.canvas + \" canvas\"}\u003e\u003c/div\u003e\n      \u003c/div\u003e\n    )\n  }\n\n  componentDidMount() {\n    let container = d3.select(\"#pipes-container .canvas\").node(),\n        bbox = container.getBoundingClientRect();\n\n    let scene, camera;\n\n    let renderer = new THREE.WebGLRenderer();\n    renderer.setPixelRatio(window.devicePixelRatio);\n\n    renderer.setSize(bbox.width, bbox.height);\n    container.appendChild(renderer.domElement);\n\n    const SPEED = 3, // units/frame\n          R = 1, // cylinder radius\n          L = 80, // size of cube boundary\n          RADIAL_SEGMENTS = 32,\n          MAX_SEGMENTS = 70, // max segments per pipe\n          MIN_LENGTH = 5, // min length of a pipe segment\n          MAX_LENGTH = 20,\n          CUBE_CENTER = [L/2, L/2, L/2];\n\n    const initialPositions = [\n      [L/2, 0, L/2],\n      [3/4*L, 3/4*L, 0],\n      [L/2, L, L/2],\n    ];\n    const colors = [\n      0x3182bd, // blue\n      0x229954, // green\n      0xF08080, // coral\n    ];\n    const MAX_PIPES = colors.length;\n    let materials = [];\n    for (const color of colors) {\n      materials.push(new THREE.MeshStandardMaterial({color: color}));\n    }\n\n    const bounds = new THREE.Box3(new THREE.Vector3(0, 0, 0), new THREE.Vector3(L, L, L));\n\n    // utils\n    const randInt = function(min, max) {\n      return Math.floor(Math.random() * (max - min)) + min;\n    }\n\n    const randChoice = function(arr) {\n      return arr[Math.floor(Math.random()*arr.length)];\n    }\n\n    const newDirection = function(old_dir, position) {\n      // return a new direction vector such that:\n      //   - new direction is orthogonal to old direction\n      //   - a pipe going in new_direction with MAX_LENGTH will stay in bounds\n      let validDirs = directions.filter((new_dir) =\u003e {\n        return (vector_dot(old_dir, new_dir) === 0) \u0026\u0026\n              willBeInBounds(new_dir, position)\n      });\n      return randChoice(validDirs);\n    }\n\n    const willBeInBounds = function(dir, position) {\n      const end_position = vector_add(position, vector_scale(dir, MAX_LENGTH + 2));\n      return bounds.containsPoint(new THREE.Vector3(...end_position));\n    }\n\n    // utility functions for working with vectors\n    // could probably make this cleaner by not converting between\n    // js lists and THREE.Vector3's\n    const pos_to_vec = function(pos) {\n      return [pos.x, pos.y, pos.z];\n    }\n\n    const vector_scale = function(v, s) {\n      let result = [];\n      for (let i = 0; i \u003c v.length; i++) {\n        result.push(v[i] * s);\n      }\n      return result;\n    }\n\n    const vector_add = function(v1, v2) {\n      let result = [];\n      for (let i = 0; i \u003c v1.length; i++) {\n        result.push(v1[i] + v2[i]);\n      }\n      return result;\n    }\n\n    const vector_dot = function(v1, v2) {\n      let result = 0;\n      for (let i = 0; i \u003c v1.length; i++) {\n        result += v1[i] * v2[i];\n      }\n      return result;\n    }\n\n    const createCylinder = function() {\n      let geometry = new THREE.CylinderGeometry(R, R, 0, RADIAL_SEGMENTS);\n      let material = materials[numPipes];\n      let mesh = new THREE.Mesh(geometry, material);\n      scene.add(mesh);\n      return mesh;\n    }\n\n    const createSphere = function() {\n      let geometry = new THREE.SphereGeometry(R * 1.2, RADIAL_SEGMENTS, RADIAL_SEGMENTS);\n      let material = new THREE.MeshStandardMaterial({color: colors[numPipes]});\n      let mesh = new THREE.Mesh(geometry, material);\n      scene.add(mesh);\n      return mesh;\n    }\n\n    const rotateCylinder = function(c) {\n      if (Math.abs(c.direction[0]) === 1) {\n        c.mesh.rotateZ(Math.PI / 2);\n      } else if (Math.abs(c.direction[2]) === 1) {\n        c.mesh.rotateX(Math.PI / 2);\n      }\n    }\n\n    const computeCameraPos = function() {\n      const x = L * 1.5 * Math.sin(theta);\n      const y = L * 1.5 * (Math.cos(theta) + 1);\n      return [x, L/2, y];\n    }\n\n    const updateCamera = function() {\n      camera.position.set(...computeCameraPos())\n      camera.lookAt(...CUBE_CENTER)\n    }\n\n    const directions = [\n      [1, 0, 0],\n      [0, 1, 0],\n      [0, 0, 1],\n      [-1, 0, 0],\n      [0, -1, 0],\n      [0, 0, -1],\n    ]\n\n    let numSegments; // number of pipe segments that have been created\n    let numPipes; // number of pipes that have been created\n    let c; // keeps track of the current cylinder segment\n    let theta = 8; // current camera rotation\n    let omega = 0.01; // rotational speed\n    let rotateCamera = false;\n\n    let animationRequestId;\n\n    const animate = function() {\n      animationRequestId = requestAnimationFrame(animate);\n\n      if (c.length \u003c c.max_length) {\n        c.length += SPEED;\n        c.mesh.geometry.dispose();\n        c.mesh.geometry = new THREE.CylinderGeometry(R, R, c.length, RADIAL_SEGMENTS);\n        // need to make sure cylinder only grows in one direction\n        const old_pos = pos_to_vec(c.mesh.position);\n        const new_pos = vector_add(old_pos, vector_scale(c.direction, SPEED/2));\n        c.mesh.position.set(...new_pos);\n      } else if (numSegments++ \u003c MAX_SEGMENTS) {\n        // new pipe segment\n        const end_position = vector_add(pos_to_vec(c.mesh.position), vector_scale(c.direction, c.length/2));\n        const old_pos = pos_to_vec(c.mesh.position);\n        const new_pos = vector_add(old_pos, vector_scale(c.direction, c.length/2));\n        c = {\n          length: 0,\n          direction: newDirection(c.direction, end_position),\n          max_length: randInt(MIN_LENGTH, MAX_LENGTH),\n          mesh: createCylinder(),\n        }\n        c.mesh.position.set(...new_pos);\n        rotateCylinder(c);\n        // create sphere at junction\n        let sphere = createSphere();\n        sphere.position.set(...new_pos);\n      } else if (numPipes \u003c MAX_PIPES) {\n        // finish the old pipe with a sphere\n        const position = vector_add(pos_to_vec(c.mesh.position), vector_scale(c.direction, c.length/2));\n        let sphere = createSphere();\n        sphere.position.set(...position);\n\n        if (numPipes \u003c MAX_PIPES - 1) {\n          numPipes++;\n          numSegments = 0;\n          newPipe(initialPositions[numPipes]);\n        } else {\n          init();\n        }\n      }\n\n      if (rotateCamera) {\n        theta += omega;\n        updateCamera();\n      }\n\n      renderer.render(scene, camera);\n    }\n\n    const newPipe = function(position) {\n      c = {\n        length: 0,\n        direction: newDirection([0, 0, 0], position),\n        max_length: randInt(3, 5),\n        mesh: createCylinder(),\n      };\n      rotateCylinder(c);\n      c.mesh.position.set(...position);\n\n      let s = createSphere();\n      s.position.set(...position);\n    }\n\n    const setScene = function() {\n      scene = new THREE.Scene();\n      camera = new THREE.PerspectiveCamera(75, bbox.width/bbox.height, 0.1, 1000);\n\n      updateCamera();\n\n      let light = new THREE.AmbientLight(0x404040, 3);\n      scene.add(light);\n\n      let pointLight = new THREE.PointLight(0x404040, 3, 0);\n      pointLight.position.set(L, L, L);\n      scene.add(pointLight);\n\n      renderer.render(scene, camera);\n    }\n\n    const init = function() {\n      setScene();\n\n      numSegments = 0;\n      numPipes = 0;\n\n      newPipe(initialPositions[0]);\n\n      cancelAnimationFrame(animationRequestId);\n\n      animate();\n    }\n\n    setScene();\n\n    d3.select(\"#pipes-container button[name=start]\").on(\"click\", init);\n    d3.select(\"#pipes-container input[name=toggle-rotate\").on(\"change\", () =\u003e rotateCamera = !rotateCamera)\n  }\n}\n\n// Downstream code is set up to display only functional components.\nexport default function PipesFn() { return \u003cPipes /\u003e }\n","codeFilename":"pipes.jsx","hasReactComponent":true,"pinned":true,"title":"The Windows \"Pipes\" Screensaver","date":"2020-04-23","languages":["js","three.js"]}},"__N_SSG":true},"page":"/sketches/[id]","query":{"id":"pipes"},"buildId":"CwgKdIK8AqblozSXCPnVa","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-dccdf6a71d009d028b56.js"></script><script src="/_next/static/chunks/main-70acde2203962b3dc5d4.js" async=""></script><script src="/_next/static/chunks/webpack-50d38cb9c3dd5374e2a2.js" async=""></script><script src="/_next/static/chunks/framework.0a4392dc64510ab178c1.js" async=""></script><script src="/_next/static/chunks/commons.6d3bde474c27debf47e2.js" async=""></script><script src="/_next/static/chunks/pages/_app-1018bc17b6123053b3bf.js" async=""></script><script src="/_next/static/chunks/fe66c3e56503ac18952228a608ca3464c3766972.02ceb7646fd5a00b4908.js" async=""></script><script src="/_next/static/chunks/pages/sketches/%5Bid%5D-efff1a0c2435fd0b2b31.js" async=""></script><script src="/_next/static/CwgKdIK8AqblozSXCPnVa/_buildManifest.js" async=""></script><script src="/_next/static/CwgKdIK8AqblozSXCPnVa/_ssgManifest.js" async=""></script></body></html>